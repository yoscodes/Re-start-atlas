# 投稿詳細ページの改善まとめ

## 実装した改善点

### 1. データ取得層の堅牢化

#### ✅ steps の ORDER BY を DB 側で保証
- **変更**: `20250201000000_add_post_detail_rpc.sql`
- **内容**: `ORDER BY rs.step_order ASC, rs.id ASC` を明示的に指定
- **理由**: 「DB = 真実」の思想。UIでsortするのはNG。時間の流れをDB側で保証

#### ✅ フェーズ制御の境界値を定数化
- **変更**: `lib/domain/phase-visibility.ts` を新規作成
- **内容**: 
  - `PHASE_VISIBILITY_CONFIG.LOCK_LEVEL = 3`（C以降をロック）
  - `SECTION_LEVELS` で各セクションのレベルを定義
  - `shouldBlurSection()` 関数で境界値を判定
- **理由**: 将来 Lv0/Lv4 を追加する際に壊れない設計

#### ✅ ロック文言の固定化
- **変更**: `lib/domain/phase-visibility.ts`
- **内容**: `PHASE_LOCK_MESSAGE` 定数で固定文言を定義
  - title: `🔒 この先は、今のフェーズでは閲覧できません`
  - description: `あなたが進めば、必ず見られます`
- **理由**: スクショ・SNS・比較でブレないように固定

### 2. UI改善

#### ✅ [B] Stats: 未入力の数字は表示しない
- **変更**: `components/PostDetailStats.tsx`
- **内容**: `formatSearchFields` が既にnullチェック済み。コメントで明記
- **理由**: 「—」は出さない（ノイズになる）

#### ✅ [F] 今の状態: 完了/継続中バッジ追加
- **変更**: `components/PostDetailCurrentStatus.tsx`
- **内容**: `recovered_at` の有無で完了/継続中を判定し、バッジ表示
- **理由**: 成功談にしない。完了/継続中を視覚的に区別

#### ✅ [G] 過去の自分へ: 署名を追加
- **変更**: `components/PostDetailMessage.tsx`
- **内容**: テキストの最後に `— ◯年前の自分へ` を追加
- **理由**: 「時間」をより強く出す

#### ✅ [A] Header: 投稿日を追加
- **変更**: `components/PostDetailHeader.tsx`
- **内容**: タイトルの下に相対日時を表示
- **理由**: SEO構造化データ用。投稿日を固定位置に配置

### 3. フェーズ制御の改善

#### ✅ セクション単位のぼかし判定
- **変更**: `app/posts/[id]/page.tsx`
- **内容**: 各セクション（C, D, E, F, G）を個別に判定
- **理由**: 境界値を定数化し、将来の拡張に耐える

## 評価された正しい実装

### ✅ データ取得層
- 投稿 + steps の一括取得
- `is_summary_only` を RPC で確定させて返す
- 型定義 → Server Action → UI の一直線
- API直叩き耐性 + 将来の課金耐性

### ✅ 7ブロック構成UI
- A〜G の順番が「時間」と一致している
- A〜B：客観 / C〜D：地獄 / E：転機 / F〜G：余韻
- 読む人の脳負荷が最小

### ✅ 各ブロックの設計
- **[A] Header**: author情報を出していない（再現性ファースト）
- **[B] Stats**: 数字を感情より先に出している
- **[C] 詰んだ理由**: 引用ブロック風で「静か」に
- **[D] 行動ログ**: 失敗 = オレンジ系、`failed_reason` を必須
- **[E] 転機ポイント**: 1つだけ・強調（再現性の芽）
- **[F] 今の状態**: 成功談にしていない
- **[G] 過去の自分へ**: このプロダクトの魂

### ✅ フェーズ制御
- Lv1 → Lv3 を完全遮断しない
- A〜B は見せる、C以降は「届きそうで届かない」
- 課金・成長・承認欲求のすべてに効く設計

## 将来の拡張余地

### [D] 行動ログ
- 失敗ステップに「その時の判断理由（任意）」を将来足せる余地を残す
- 現時点ではコメントだけでOK

### [C] 詰んだ理由
- 行数が長くなりすぎた場合、続きを読むを Lv2以上限定にしてもいい

## 注意事項

- **steps の順序**: DB側で保証されている（`ORDER BY step_order ASC, id ASC`）
- **フェーズ境界値**: `PHASE_VISIBILITY_CONFIG.LOCK_LEVEL` で管理
- **ロック文言**: `PHASE_LOCK_MESSAGE` で固定（変更禁止）
- **数字の表示**: 未入力の場合はセクション全体を非表示（—は出さない）
